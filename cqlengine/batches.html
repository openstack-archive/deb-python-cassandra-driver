<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Batch Queries &#8212; Cassandra Driver 3.10 documentation</title>
    
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.10',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Connections (experimental)" href="connections.html" />
    <link rel="prev" title="Making Queries" href="queryset.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="connections.html" title="Connections (experimental)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="queryset.html" title="Making Queries"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Cassandra Driver 3.10 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../object_mapper.html" accesskey="U">Object Mapper</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Batch Queries</a><ul>
<li><a class="reference internal" href="#batch-query-general-use-pattern">Batch Query General Use Pattern</a></li>
<li><a class="reference internal" href="#batch-query-execution-callbacks">Batch Query Execution Callbacks</a><ul>
<li><a class="reference internal" href="#logged-vs-unlogged-batches">Logged vs Unlogged Batches</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="queryset.html"
                        title="previous chapter">Making Queries</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="connections.html"
                        title="next chapter">Connections (experimental)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/cqlengine/batches.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="batch-queries">
<h1>Batch Queries<a class="headerlink" href="#batch-queries" title="Permalink to this headline">¶</a></h1>
<p>cqlengine supports batch queries using the BatchQuery class. Batch queries can be started and stopped manually, or within a context manager. To add queries to the batch object, you just need to precede the create/save/delete call with a call to batch, and pass in the batch object.</p>
<div class="section" id="batch-query-general-use-pattern">
<h2>Batch Query General Use Pattern<a class="headerlink" href="#batch-query-general-use-pattern" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>You can only create, update, and delete rows with a batch query, attempting to read rows out of the database with a batch query will fail.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cassandra.cqlengine.query</span> <span class="kn">import</span> <span class="n">BatchQuery</span>

<span class="c1">#using a context manager</span>
<span class="k">with</span> <span class="n">BatchQuery</span><span class="p">()</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">em1</span> <span class="o">=</span> <span class="n">ExampleModel</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">example_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
    <span class="n">em2</span> <span class="o">=</span> <span class="n">ExampleModel</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">example_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
    <span class="n">em3</span> <span class="o">=</span> <span class="n">ExampleModel</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">example_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>

<span class="c1"># -- or --</span>

<span class="c1">#manually</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">BatchQuery</span><span class="p">()</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">em1</span> <span class="o">=</span> <span class="n">ExampleModel</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">example_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
<span class="n">em2</span> <span class="o">=</span> <span class="n">ExampleModel</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">example_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
<span class="n">em3</span> <span class="o">=</span> <span class="n">ExampleModel</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">example_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
<span class="n">b</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># updating in a batch</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">BatchQuery</span><span class="p">()</span>
<span class="n">em1</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;new description&quot;</span>
<span class="n">em1</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">em2</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;another new description&quot;</span>
<span class="n">em2</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">b</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># deleting in a batch</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">BatchQuery</span><span class="p">()</span>
<span class="n">ExampleModel</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">some_id</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="n">ExampleModel</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">some_id2</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="n">b</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>Typically you will not want the block to execute if an exception occurs inside the <cite>with</cite> block.  However, in the case that this is desirable, it&#8217;s achievable by using the following syntax:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">BatchQuery</span><span class="p">(</span><span class="n">execute_on_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
    <span class="n">LogEntry</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mystery_function</span><span class="p">()</span> <span class="c1"># exception thrown in here</span>
    <span class="n">LogEntry</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># this code is never reached due to the exception, but anything leading up to here will execute in the batch.</span>
</pre></div>
</div>
<p>If an exception is thrown somewhere in the block, any statements that have been added to the batch will still be executed.  This is useful for some logging situations.</p>
</div></blockquote>
</div>
<div class="section" id="batch-query-execution-callbacks">
<h2>Batch Query Execution Callbacks<a class="headerlink" href="#batch-query-execution-callbacks" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>In order to allow secondary tasks to be chained to the end of batch, BatchQuery instances allow callbacks to be
registered with the batch, to be executed immediately after the batch executes.</p>
<p>Multiple callbacks can be attached to same BatchQuery instance, they are executed in the same order that they
are added to the batch.</p>
<p>The callbacks attached to a given batch instance are executed only if the batch executes. If the batch is used as a
context manager and an exception is raised, the queued up callbacks will not be run.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">batch</span> <span class="o">=</span> <span class="n">BatchQuery</span><span class="p">()</span>

<span class="n">batch</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">my_callback</span><span class="p">)</span>
<span class="n">batch</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="s1">&#39;positional arg&#39;</span><span class="p">,</span> <span class="n">named_arg</span><span class="o">=</span><span class="s1">&#39;named arg value&#39;</span><span class="p">)</span>

<span class="c1"># if you need reference to the batch within the callback,</span>
<span class="c1"># just trap it in the arguments to be passed to the callback:</span>
<span class="n">batch</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">my_callback</span><span class="p">,</span> <span class="n">cqlengine_batch</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>

<span class="c1"># once the batch executes...</span>
<span class="n">batch</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># the effect of the above scheduled callbacks will be similar to</span>
<span class="n">my_callback</span><span class="p">()</span>
<span class="n">my_callback</span><span class="p">(</span><span class="s1">&#39;positional arg&#39;</span><span class="p">,</span> <span class="n">named_arg</span><span class="o">=</span><span class="s1">&#39;named arg value&#39;</span><span class="p">)</span>
<span class="n">my_callback</span><span class="p">(</span><span class="n">cqlengine_batch</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
<p>Failure in any of the callbacks does not affect the batch&#8217;s execution, as the callbacks are started after the execution
of the batch is complete.</p>
</div></blockquote>
<div class="section" id="logged-vs-unlogged-batches">
<h3>Logged vs Unlogged Batches<a class="headerlink" href="#logged-vs-unlogged-batches" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>By default, queries in cqlengine are LOGGED, which carries additional overhead from UNLOGGED.  To explicitly state which batch type to use, simply:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cassandra.cqlengine.query</span> <span class="kn">import</span> <span class="n">BatchType</span>
<span class="k">with</span> <span class="n">BatchQuery</span><span class="p">(</span><span class="n">batch_type</span><span class="o">=</span><span class="n">BatchType</span><span class="o">.</span><span class="n">Unlogged</span><span class="p">)</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
    <span class="n">LogEntry</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">LogEntry</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="connections.html" title="Connections (experimental)"
             >next</a> |</li>
        <li class="right" >
          <a href="queryset.html" title="Making Queries"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Cassandra Driver 3.10 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../object_mapper.html" >Object Mapper</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2017 DataStax.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>